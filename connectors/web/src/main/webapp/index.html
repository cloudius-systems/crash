<!DOCTYPE HTML>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <title>JSON-RPC Demo for JQuery Terminal Emulator</title>
    <script src="js/jquery-1.7.1.min.js"></script>
    <script src="js/jquery.mousewheel-min.js"></script>
    <script src="js/jquery.terminal-0.7.6.js"></script>
    <link href="css/jquery.terminal.css" rel="stylesheet"/>
    </head>
<body>

<script>


  var cls = "\033[2J\033[1;1H";
  var CRaSH = {};

  //
  CRaSH.socket = null;
  CRaSH.connect = (function(host){
    if ('WebSocket' in window) {
      CRaSH.socket = new WebSocket(host);
    } else if ('MozWebSocket' in window) {
      CRaSH.socket = new MozWebSocket(host);
    } else {
      Console.log('Error: WebSocket is not supported by this browser.');
      return;
    }
    CRaSH.socket.onopen = function () {
      Console.log('Info: WebSocket connection opened.');
      CRaSH.terminal.resume();
    };
    CRaSH.socket.onclose = function () {
      Console.log('Info: WebSocket closed.');
      CRaSH.terminal.pause();
    };
    CRaSH.socket.onmessage = function (message) {
      var event = $.parseJSON(message.data);
      var type = event.type;
      if (type == "print") {
        var text = event.data;
        while (true) {
          var index = text.indexOf(cls);
          if (index == -1) {
            break;
          } else {
            CRaSH.terminal.echo(text.substring(0, index));
            CRaSH.terminal.clear();
            text = text.substring(index + cls.length, text.length);
          }
        }
        CRaSH.terminal.echo(text);
      } else if (type == "prompt") {
        CRaSH.terminal.set_prompt(event.data);
      } else if (type == "end") {
        CRaSH.terminal.resume();
      } else if (type == "complete") {
        var c = CRaSH.completion;
        var completions = event.data;
        for (var i = 0; i < completions.length; i++) {
          completions[i] = c.string + completions[i];
        }
        c.callback(completions);
      }
    };
  });

  //
  CRaSH.initialize = function($) {

    // Create a paused terminal
    var terminal = $('#term_demo').terminal(function (command, term) {
      var socket = CRaSH.socket;
      if (socket != null) {
        var event = {
          type: "execute",
          width: term.cols(),
          height: term.rows(),
          command: command
        };
        socket.send(JSON.stringify(event));
        term.pause();
      }
    }, {
      greetings: '',
      name: 'crash',
      enabled: false,
      height: 400,
      width: 800,
      prompt: '',
      tabcompletion: true,
      completion: function(term, string, callback) {
        var prefix = term.get_command();
        CRaSH.completion = {
          callback: callback,
          prefix: prefix,
          string: string
        };
        CRaSH.socket.send(JSON.stringify({type: "complete",prefix:prefix}));
      },
      keypress: function(event, term) {
        if (event.keyCode == 3) {
          CRaSH.socket.send(JSON.stringify({type: "cancel"}));
        }
      }
    });

    // Create web socket url
    var path = window.location.pathname;
    var ctx = path.substring(0, path.indexOf('/', 1));
    var protocol;
    if (window.location.protocol == 'http:') {
      protocol = 'ws';
    } else {
      protocol = 'wss';
    }
    var url = protocol + '://' + window.location.host + ctx + '/crash';

    // Set state and connect
    CRaSH.terminal = terminal;
    CRaSH.connect(url);
  };



  //
  $(function() {

    //
    CRaSH.initialize($);

  });

  var Console = {};
  Console.log = (function(message) {
//    alert(message);
  });

</script>

  <div id="term_demo"></div>

</body>
</html>